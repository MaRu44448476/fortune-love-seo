# 🚀 運用マニュアル

## 📋 目次
1. [サービス概要](#サービス概要)
2. [システム構成](#システム構成)
3. [日次運用](#日次運用)
4. [監視・アラート](#監視アラート)
5. [障害対応](#障害対応)
6. [メンテナンス](#メンテナンス)
7. [セキュリティ](#セキュリティ)
8. [バックアップ・復旧](#バックアップ復旧)

## 🎯 サービス概要

### サービス名
恋愛占いサイト - Fortune Love

### 主要機能
- 576通りの恋愛占い（血液型×星座×干支）
- 日替わりランキング
- プレミアム機能（詳細分析・週間占い）
- ユーザー認証・決済システム

### 技術スタック
- **Frontend**: Next.js 15 + TypeScript + Tailwind CSS
- **Backend**: Next.js API Routes
- **Database**: PostgreSQL (Supabase)
- **Authentication**: NextAuth.js
- **Payment**: Stripe
- **Hosting**: Vercel
- **Monitoring**: Vercel Analytics + Google Analytics 4

## 🏗️ システム構成

### アーキテクチャ図
```
[ユーザー] → [Vercel CDN] → [Next.js App] → [Supabase DB]
                                ↓
                         [Stripe API] + [Google Analytics]
```

### 主要コンポーネント
- **Web Application**: Vercel上のNext.jsアプリ
- **Database**: Supabase PostgreSQL
- **Authentication**: NextAuth.js + Google OAuth
- **Payment**: Stripe サブスクリプション
- **Analytics**: GA4 + Vercel Analytics

## 📅 日次運用

### 🌅 朝の確認事項（9:00）
- [ ] サイトの稼働状況確認
- [ ] 前日のエラーログ確認
- [ ] データベース接続状況確認
- [ ] 決済処理の正常性確認
- [ ] 占いランキングの更新確認

### 🌆 夕方の確認事項（18:00）
- [ ] 当日のアクセス状況確認
- [ ] パフォーマンス指標チェック
- [ ] ユーザーサポート問い合わせ対応
- [ ] セキュリティログ確認

### 🌙 深夜の処理（0:00）
- [ ] 日替わり占いデータの更新
- [ ] ランキングの再計算
- [ ] データベースバックアップ
- [ ] アクセスログの集計

## 📊 監視・アラート

### 監視項目

#### システム監視
- **Uptime**: サイトの稼働状況（99.9%以上）
- **Response Time**: レスポンス時間（< 2秒）
- **Error Rate**: エラー率（< 1%）
- **Database**: 接続プール・クエリ実行時間

#### ビジネス監視
- **占い実行数**: 日次の占い実行回数
- **新規登録数**: 日次の新規ユーザー登録
- **プレミアム登録数**: プレミアムプラン登録数
- **収益**: 日次・月次の収益額

### アラート設定

#### 緊急アラート（即座に対応）
- サイトダウン（5分以上）
- データベース接続エラー
- 決済処理エラー（10件以上/時間）
- セキュリティ侵害の疑い

#### 警告アラート（24時間以内に対応）
- レスポンス時間悪化（> 5秒）
- エラー率上昇（> 5%）
- ディスク使用量高（> 80%）
- 異常なアクセスパターン

### 監視ダッシュボード
- **Vercel Dashboard**: デプロイ・パフォーマンス状況
- **Supabase Dashboard**: データベース状況
- **Stripe Dashboard**: 決済・売上状況
- **Google Analytics**: ユーザー行動分析

## 🚨 障害対応

### 障害レベル定義

#### レベル1（緊急）- 1時間以内に復旧
- サービス全体停止
- データベース障害
- 決済システム停止
- セキュリティ侵害

#### レベル2（高）- 4時間以内に復旧
- 特定機能の停止
- パフォーマンス大幅劣化
- データ不整合

#### レベル3（中）- 24時間以内に復旧
- 軽微な機能不具合
- パフォーマンス軽微劣化
- UI/UXの問題

### 障害対応フロー

#### 1. 初期対応（検知から15分以内）
1. **障害内容の把握**
   - 影響範囲の特定
   - 原因の仮説立て
   - ユーザー影響の評価

2. **関係者への連絡**
   - 開発チームへの通知
   - 必要に応じて経営陣への報告
   - ユーザーへの障害告知準備

#### 2. 応急処置（30分以内）
1. **サービス復旧の実施**
   - Vercelの再デプロイ
   - データベースの再起動
   - キャッシュのクリア
   - 外部サービスの状況確認

2. **代替手段の提供**
   - メンテナンスページの表示
   - 一部機能の停止による負荷軽減

#### 3. 本格復旧（レベルに応じた時間内）
1. **根本原因の特定**
   - ログ解析
   - 関連システムの調査
   - 再現テストの実施

2. **修正・復旧作業**
   - コード修正
   - データ修正
   - 設定変更
   - 動作確認

#### 4. 事後対応
1. **障害報告書の作成**
   - 発生時刻・復旧時刻
   - 原因・影響範囲
   - 対応内容・改善策

2. **再発防止策の実施**
   - システム改善
   - 監視強化
   - 手順書の更新

### 緊急連絡先
- **開発責任者**: [連絡先]
- **運用責任者**: [連絡先]
- **Vercel サポート**: support@vercel.com
- **Supabase サポート**: support@supabase.io

## 🔧 メンテナンス

### 定期メンテナンス

#### 週次メンテナンス（日曜 2:00-4:00）
- [ ] データベースの最適化
- [ ] 不要ログの削除
- [ ] パフォーマンス分析
- [ ] セキュリティパッチの適用

#### 月次メンテナンス（第1日曜 2:00-6:00）
- [ ] フルバックアップの実行
- [ ] 依存関係の更新
- [ ] セキュリティ監査
- [ ] 容量・コスト分析

### メンテナンス手順

#### 1. 事前準備
- [ ] ユーザーへの事前告知（48時間前）
- [ ] バックアップの作成
- [ ] ロールバック計画の準備
- [ ] 作業チェックリストの確認

#### 2. メンテナンス実行
- [ ] メンテナンスページの表示
- [ ] 作業実施
- [ ] 動作確認
- [ ] パフォーマンステスト

#### 3. 作業完了
- [ ] サービス復旧
- [ ] 動作確認
- [ ] ユーザーへの完了報告
- [ ] 作業報告書の作成

## 🔒 セキュリティ

### セキュリティ監視

#### 日次確認事項
- [ ] 不正アクセス試行のログ確認
- [ ] 異常なAPIコール回数チェック
- [ ] 新規ユーザー登録の妥当性確認
- [ ] 決済データの整合性確認

#### 週次確認事項
- [ ] セキュリティパッチの確認・適用
- [ ] アクセス権限の監査
- [ ] SSL証明書の有効期限確認
- [ ] 脆弱性スキャンの実行

### インシデント対応

#### セキュリティインシデント検知時
1. **即座に実施（5分以内）**
   - 該当アカウントの無効化
   - 不正アクセス元IPのブロック
   - 影響範囲の初期調査

2. **1時間以内に実施**
   - 詳細調査の開始
   - 関係者への報告
   - 必要に応じてサービス停止

3. **24時間以内に実施**
   - 影響を受けたユーザーへの通知
   - セキュリティ対策の強化
   - 再発防止策の実装

## 💾 バックアップ・復旧

### バックアップ戦略

#### データベースバックアップ
- **頻度**: 日次（毎日 3:00）
- **保存期間**: 30日間
- **保存場所**: Supabase自動バックアップ + 外部ストレージ
- **検証**: 週次でリストア確認

#### アプリケーションバックアップ
- **頻度**: デプロイ時
- **保存場所**: GitHub リポジトリ
- **ブランチ戦略**: main, staging, development

### 復旧手順

#### データベース復旧
1. **バックアップファイルの確認**
2. **復旧ポイントの決定**
3. **Supabaseでの復旧実行**
4. **データ整合性の確認**
5. **アプリケーションの再起動**

#### アプリケーション復旧
1. **安定版ブランチへのロールバック**
2. **Vercelでの再デプロイ**
3. **動作確認**
4. **ユーザーへの状況報告**

## 📞 サポート・問い合わせ対応

### 問い合わせ分類

#### レベル1（即座に対応）
- 決済関連の問題
- アカウントロック
- セキュリティに関する報告

#### レベル2（4時間以内）
- 機能の不具合報告
- プレミアム機能の問題
- データ表示の異常

#### レベル3（24時間以内）
- 一般的な使い方の質問
- 機能改善の要望
- その他の問い合わせ

### 対応フロー
1. **問い合わせ受付**
2. **内容の確認・分類**
3. **対応者のアサイン**
4. **調査・対応**
5. **ユーザーへの回答**
6. **フォローアップ**

## 📊 レポート・分析

### 日次レポート
- アクセス数・ユーザー数
- 占い実行回数
- エラー発生件数
- プレミアム登録数

### 週次レポート
- パフォーマンス分析
- ユーザー行動分析
- 収益分析
- システム状況

### 月次レポート
- 総合的なKPI分析
- セキュリティ状況
- 運用コスト分析
- 改善提案

---

## 📞 緊急時連絡先

### 技術サポート
- **Vercel**: support@vercel.com
- **Supabase**: support@supabase.io
- **Stripe**: support@stripe.com

### 社内連絡先
- **開発責任者**: [氏名・連絡先]
- **運用責任者**: [氏名・連絡先]
- **セキュリティ責任者**: [氏名・連絡先]

### エスカレーション
1. **第1次対応**: 運用担当者
2. **第2次対応**: 開発責任者
3. **第3次対応**: 技術責任者・経営陣

---

**最終更新**: 2025年1月  
**次回見直し**: 2025年4月